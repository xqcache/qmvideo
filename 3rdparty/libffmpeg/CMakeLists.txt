set(TARGET_NAME libffmpeg)

if(NOT CMAKE_RUNTIME_OUTPUT_DIRECTORY)
    message(FATAL_ERROR "Please set the CMAKE_RUNTIME_OUTPUT_DIRECTORY")
endif()

add_library(${TARGET_NAME} SHARED IMPORTED GLOBAL)
target_include_directories(${TARGET_NAME} INTERFACE "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>")

list(APPEND DEPENDENT_LIBRARIES "avcodec.lib")
list(APPEND DEPENDENT_LIBRARIES "avutil.lib")
list(APPEND DEPENDENT_LIBRARIES "swscale.lib")

if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(DEPENDENT_LIBRARY_PATHS ${DEPENDENT_LIBRARIES})
    list(TRANSFORM DEPENDENT_LIBRARY_PATHS PREPEND "${CMAKE_CURRENT_SOURCE_DIR}/lib/debug/")

    set_target_properties(${TARGET_NAME} PROPERTIES
        IMPORTED_LOCATION "${CMAKE_CURRENT_SOURCE_DIR}/bin/debug/avformat-61.dll"
        IMPORTED_IMPLIB "${CMAKE_CURRENT_SOURCE_DIR}/lib/debug/avformat.lib"
        INTERFACE_LINK_LIBRARIES "${DEPENDENT_LIBRARY_PATHS}")

    list(APPEND RUNTIME_DEPENDENT_FILES ${CMAKE_CURRENT_SOURCE_DIR}/bin/debug/avformat-61.dll)
    list(APPEND RUNTIME_DEPENDENT_FILES ${CMAKE_CURRENT_SOURCE_DIR}/bin/debug/avcodec-61.dll)
    list(APPEND RUNTIME_DEPENDENT_FILES ${CMAKE_CURRENT_SOURCE_DIR}/bin/debug/avutil-59.dll)
    list(APPEND RUNTIME_DEPENDENT_FILES ${CMAKE_CURRENT_SOURCE_DIR}/bin/debug/swscale-8.dll)
else()
endif()

foreach(ITEM ${RUNTIME_DEPENDENT_FILES})
    get_filename_component(ITEM_FILENAME ${ITEM} NAME)
    set(ITEM_OUTPATH ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/${ITEM_FILENAME})
    add_custom_command(OUTPUT ${ITEM_OUTPATH}
        COMMAND ${CMAKE_COMMAND} -E copy_if_different ${ITEM} ${ITEM_OUTPATH}
    )
    list(APPEND RUNTIME_DEPENDENT_FILEPATHS ${ITEM_OUTPATH})
endforeach()

add_custom_target(${TARGET_NAME}-copydeps DEPENDS ${RUNTIME_DEPENDENT_FILEPATHS})
add_dependencies(${TARGET_NAME} ${TARGET_NAME}-copydeps)